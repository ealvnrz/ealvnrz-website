---
import PageHead from '@/components/PageHead.astro'
import { Badge } from '@/components/ui/badge'
import Layout from '@/layouts/Layout.astro'
import grantsData from '@/data/grants.json'

interface Grant {
  title: string
  agency: string
  period: string
  role: string
  status: 'active' | 'completed' | 'pending'
  description?: string
  links?: {
    website?: string
    report?: string
  }
}

const grants: Grant[] = (grantsData.grants as Grant[]).sort((a, b) => {
  // Sort by status: active first, then completed, then pending
  const statusOrder: Record<'active' | 'completed' | 'pending', number> = { active: 0, completed: 1, pending: 2 }
  const statusDiff = statusOrder[a.status] - statusOrder[b.status]
  if (statusDiff !== 0) return statusDiff
  
  // Within same status, sort by period (most recent first)
  // Extract year from period (assuming format like "2024-2025" or "2024")
  const getYear = (period: string) => {
    const match = period.match(/\d{4}/)
    return match ? parseInt(match[0]) : 0
  }
  return getYear(b.period) - getYear(a.period)
})

const activeGrants = grants.filter(g => g.status === 'active')
const completedGrants = grants.filter(g => g.status === 'completed')
const pendingGrants = grants.filter(g => g.status === 'pending')
---

<Layout class="max-w-5xl">
  <PageHead slot="head" title="Grants" />
  <section class="flex flex-col gap-y-6">
    <div>
      <h1 class="text-4xl font-bold mb-2">Grants & Funding</h1>
      <p class="text-muted-foreground">
        Research grants and funding awards I have received or participated in.
      </p>
    </div>

    {activeGrants.length > 0 && (
      <div>
        <details open class="group">
          <summary class="cursor-pointer list-none">
            <h2 class="text-2xl font-semibold mb-4 inline-flex items-center gap-2">
              Active Grants
              <span class="text-sm font-normal text-muted-foreground group-open:rotate-180 transition-transform">
                ▼
              </span>
            </h2>
          </summary>
          <ul class="flex flex-col gap-y-4">
            {
              activeGrants.map((grant) => (
                <li class="border bg-muted/30 p-4 rounded-md flex flex-col gap-y-1.5">
                  <div class="flex flex-col gap-y-0.5">
                    <div class="flex items-start justify-between gap-2">
                      <h3 class="text-base font-semibold leading-tight flex-1">{grant.title}</h3>
                      <Badge variant="default" className="text-xs shrink-0">Active</Badge>
                    </div>
                    <p class="text-muted-foreground text-xs">
                      <span class="font-medium">{grant.agency}</span>
                      {' • '}
                      {grant.period}
                    </p>
                    <p class="text-muted-foreground text-xs">
                      Role: <span class="font-medium">{grant.role}</span>
                    </p>
                  </div>
                  {
                    grant.description && (
                      <p class="text-muted-foreground text-xs mt-1">
                        {grant.description}
                      </p>
                    )
                  }
                  {
                    grant.links && (
                      <div class="flex flex-wrap gap-1.5 mt-1">
                        {
                          grant.links.website && (
                            <a
                              href={grant.links.website}
                              class="text-xs text-muted-foreground hover:text-foreground underline"
                              target="_blank"
                              rel="noopener noreferrer"
                            >
                              Website
                            </a>
                          )
                        }
                        {
                          grant.links.report && (
                            <a
                              href={grant.links.report}
                              class="text-xs text-muted-foreground hover:text-foreground underline"
                              target="_blank"
                              rel="noopener noreferrer"
                            >
                              Report
                            </a>
                          )
                        }
                      </div>
                    )
                  }
                </li>
              ))
            }
          </ul>
        </details>
      </div>
    )}

    {pendingGrants.length > 0 && (
      <div>
        <details open class="group">
          <summary class="cursor-pointer list-none">
            <h2 class="text-2xl font-semibold mb-4 inline-flex items-center gap-2">
              Pending Applications
              <span class="text-sm font-normal text-muted-foreground group-open:rotate-180 transition-transform">
                ▼
              </span>
            </h2>
          </summary>
          <ul class="flex flex-col gap-y-4">
            {
              pendingGrants.map((grant) => (
                <li class="border bg-muted/30 p-4 rounded-md flex flex-col gap-y-1.5">
                  <div class="flex flex-col gap-y-0.5">
                    <div class="flex items-start justify-between gap-2">
                      <h3 class="text-base font-semibold leading-tight flex-1">{grant.title}</h3>
                      <Badge variant="muted" className="text-xs shrink-0">Pending</Badge>
                    </div>
                    <p class="text-muted-foreground text-xs">
                      <span class="font-medium">{grant.agency}</span>
                      {' • '}
                      {grant.period}
                    </p>
                    <p class="text-muted-foreground text-xs">
                      Role: <span class="font-medium">{grant.role}</span>
                    </p>
                  </div>
                  {
                    grant.description && (
                      <p class="text-muted-foreground text-xs mt-1">
                        {grant.description}
                      </p>
                    )
                  }
                </li>
              ))
            }
          </ul>
        </details>
      </div>
    )}

    {completedGrants.length > 0 && (
      <div>
        <details open class="group">
          <summary class="cursor-pointer list-none">
            <h2 class="text-2xl font-semibold mb-4 inline-flex items-center gap-2">
              Completed Grants
              <span class="text-sm font-normal text-muted-foreground group-open:rotate-180 transition-transform">
                ▼
              </span>
            </h2>
          </summary>
          <ul class="flex flex-col gap-y-4">
            {
              completedGrants.map((grant) => (
                <li class="border bg-muted/30 p-4 rounded-md flex flex-col gap-y-1.5">
                  <div class="flex flex-col gap-y-0.5">
                    <h3 class="text-base font-semibold leading-tight">{grant.title}</h3>
                    <p class="text-muted-foreground text-xs">
                      <span class="font-medium">{grant.agency}</span>
                      {' • '}
                      {grant.period}
                    </p>
                    <p class="text-muted-foreground text-xs">
                      Role: <span class="font-medium">{grant.role}</span>
                    </p>
                  </div>
                  {
                    grant.description && (
                      <p class="text-muted-foreground text-xs mt-1">
                        {grant.description}
                      </p>
                    )
                  }
                  {
                    grant.links && (
                      <div class="flex flex-wrap gap-1.5 mt-1">
                        {
                          grant.links.website && (
                            <a
                              href={grant.links.website}
                              class="text-xs text-muted-foreground hover:text-foreground underline"
                              target="_blank"
                              rel="noopener noreferrer"
                            >
                              Website
                            </a>
                          )
                        }
                        {
                          grant.links.report && (
                            <a
                              href={grant.links.report}
                              class="text-xs text-muted-foreground hover:text-foreground underline"
                              target="_blank"
                              rel="noopener noreferrer"
                            >
                              Report
                            </a>
                          )
                        }
                      </div>
                    )
                  }
                </li>
              ))
            }
          </ul>
        </details>
      </div>
    )}

    {grants.length === 0 && (
      <div class="border bg-muted/30 p-8 rounded-md text-center">
        <p class="text-muted-foreground">
          No grants information available at this time.
        </p>
      </div>
    )}
  </section>
</Layout>

<style>
  /* Hide default details marker */
  details summary::-webkit-details-marker {
    display: none;
  }
  
  details summary {
    list-style: none;
  }
  
  /* Smooth transition for content */
  details[open] summary ~ * {
    animation: slideDown 0.2s ease-out;
  }
  
  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
